"/****** UPEX.S = APEX TASK FOR SUBROUTINES = REL 0.0  , JUL 79 ***************
"
"                  CHANGED   79-JUL-17    12:30
"
"       FOR USE WITH FPS-100 SUPERVISOR
"         JOSEPH E. RAMUS        MAR 79
"
"       TAB STOP SETTINGS FOR EDITOR:    9   33  60
"
"         USER SUBROUTINES TASK FOR APEX WITH FPS-100 SUPERVISOR
"
"
"         SPAD REGISTER NAMES DEFINED IN SYSDEF
"           R0 R1 R2 R3 R4 R5 R6 R7
"
"         INDEXES FOR DATA PAD X DEFINED IN SYSDEF
"           X0 X1 X2 X3
"
$TASK  777
$TITLE  UPEX
$ENTRY  UPEX,0
$EXT  SENDER
$EXT WAIT
"
"             $INSERT SYSDEF
$NOLIST
$INSERT SYSDEF
$LIST
"
"
$INSERT FHOSTC
"
"/****** UPEX = USER APEX TASK  = REL 0.0  , JUL 79 ***************************
"
"
UPEX:   NOP
"
"         WAIT FOR MESSAGE FROM HOST INTERRUPT ROUTINE
"
          DPX(X1)<EXAPEX        "MESSAGE EXCHANGE
          TRAP; DB=@WAIT; LDTMA       "WAIT FOR MESSAGE
"
"         SUPERVISOR STATE RESTORE WILL LOAD TMA, SPADS, ETC. FROM TCB
"
"                GET START ADDRESS, LOAD SPADS, AND GO
        LDMA; DB=APMSG+11       "FETCH START ADDRESS FROM MSG
        LDMA; DB=FSPAD+17       "FETCH SPAD R17
        LDSPI R0; DB=20         "INITIALIZE LOOP COUNTER
        LDTMA; DB=MD;           "PUT START ADDRESS IN TMA
          DECMA                   "FETCH SPAD R16
"                LOOP TO COUNT DOWN AND LOAD ALL SPAD REGISTERS
UPX5:   DEC R0; DB=SPFN;
            LDSPD               "SET SPD TO R0 INDEX VALUE
        LDSP; DB=MD;            "LOAD SP(SPD) FROM MD VALUE
          DECMA; BNE UPX5         "CONTINUE THE LOOP COUNTDOWN
"
"           JUMP TO OVERLAY HANDLER WHICH
"               LOADS OVERLAYS AND RUNS THE USER CODE
        JSRT
"            RETURN FROM USER CODE
"            SEND MESSAGE TO HOST - APEX IS DONE
"
        CLR R0; DPX(X0)<SPFN    "FIRST ARG FOR SENDER
        DPX(X1)<DPX(X0)         "SECOND ARG FOR SENDER
        DPX(X2)<DPX(X0)         "THIRD ARG FOR SENDER
        JSR SENDER
"              GO BACK AND WAIT FOR NEXT MESSAGE
        JMP UPEX
"
        $END
